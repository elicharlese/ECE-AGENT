{"version":3,"sources":["/Users/elicharlese/CascadeProjects/AGENT/components/chat/MiniChatWidget.tsx"],"sourcesContent":["\"use client\"\n\nimport React, { useCallback, useEffect, useMemo, useRef, useState } from \"react\"\nimport { createPortal } from \"react-dom\"\nimport { Bot, Minimize2, Maximize2, X, Plus, Mic, Circle, Code2 } from \"lucide-react\"\nimport { Textarea } from \"@/components/ui/textarea\"\nimport { Button } from \"@/components/ui/button\"\nimport { useWebSocket } from \"@/hooks/use-websocket\"\nimport { useHotkeys } from \"@/hooks/use-hotkeys\"\nimport { useHaptics } from \"@/hooks/use-haptics\"\n\n// Lightweight draggable + resizable floating chat widget.\n// - Fixed positioned (bottom-right by default)\n// - Remembers position/size/minimized in localStorage\n// - Tailwind-only styling; no external deps\n\nexport type MiniChatWidgetState = {\n  minimized: boolean\n  x: number // px from left\n  y: number // px from top\n  w: number\n  h: number\n}\n\nexport type MiniChatWidgetProps = {\n  title?: string\n  initialMinimized?: boolean\n  initialX?: number\n  initialY?: number\n  initialW?: number\n  initialH?: number\n  conversationId?: string\n}\n\nconst DEFAULT_W = 360\nconst DEFAULT_H = 420\nconst COMPACT_W = 280\nconst COMPACT_H = 260\n\nconst defaultX = () => (typeof window !== \"undefined\" ? Math.max(16, window.innerWidth - DEFAULT_W - 16) : 16)\nconst defaultY = () => (typeof window !== \"undefined\" ? Math.max(16, window.innerHeight - DEFAULT_H - 16) : 16)\n\nconst DEFAULT_STATE: MiniChatWidgetState = {\n  minimized: true,\n  x: defaultX(),\n  y: defaultY(),\n  w: DEFAULT_W,\n  h: DEFAULT_H,\n}\n\nconst STORAGE_KEY = \"miniChatWidgetState\"\nconst HINT_KEY = \"miniChatWidgetHintSeen\"\n\nexport function MiniChatWidget({\n  title = \"Quick Chat\",\n  initialMinimized,\n  initialX,\n  initialY,\n  initialW,\n  initialH,\n  conversationId,\n}: MiniChatWidgetProps) {\n  const [state, setState] = useState<MiniChatWidgetState>(() => ({\n    minimized: initialMinimized ?? DEFAULT_STATE.minimized,\n    x: initialX ?? DEFAULT_STATE.x,\n    y: initialY ?? DEFAULT_STATE.y,\n    w: initialW ?? DEFAULT_STATE.w,\n    h: initialH ?? DEFAULT_STATE.h,\n  }))\n  const [message, setMessage] = useState(\"\")\n  const [mounted, setMounted] = useState(false)\n  const [showHint, setShowHint] = useState(false)\n  const quickInputRef = useRef<HTMLInputElement | null>(null)\n\n  const { sendChatMessage, joinConversation, messages } = useWebSocket()\n  const { triggerHaptic } = useHaptics()\n  // Stable mini-chat conversation id\n  const miniChatConversationId = useMemo(() => {\n    if (conversationId) return conversationId\n    if (typeof window === \"undefined\") return \"mini-chat\"\n    const KEY = \"miniChatConversationId\"\n    let cid = localStorage.getItem(KEY)\n    if (!cid) {\n      cid = `mini-${Date.now()}-${Math.floor(Math.random() * 1e6)}`\n      try { localStorage.setItem(KEY, cid) } catch {}\n    }\n    return cid\n  }, [conversationId])\n\n  const dragging = useRef(false)\n  const resizing = useRef(false)\n  const dragStart = useRef<{ mx: number; my: number; x: number; y: number } | null>(null)\n  const sizeStart = useRef<{ mx: number; my: number; w: number; h: number } | null>(null)\n\n  // Load persisted state\n  useEffect(() => {\n    setMounted(true)\n    try {\n      const raw = localStorage.getItem(STORAGE_KEY)\n      if (raw) {\n        const parsed = JSON.parse(raw) as MiniChatWidgetState\n        setState((s) => ({\n          ...s,\n          ...parsed,\n          // allow explicit initial props to override persisted\n          minimized: initialMinimized ?? parsed.minimized,\n          x: initialX ?? parsed.x,\n          y: initialY ?? parsed.y,\n          w: initialW ?? parsed.w,\n          h: initialH ?? parsed.h,\n        }))\n      }\n    } catch {}\n  }, [initialH, initialMinimized, initialW, initialX, initialY])\n\n  // Persist state\n  useEffect(() => {\n    try {\n      localStorage.setItem(STORAGE_KEY, JSON.stringify(state))\n    } catch {}\n  }, [state])\n\n  // Hotkey: âŒ˜L focuses the quick chat input (when minimized)\n  useHotkeys([\n    {\n      combo: \"meta+l\",\n      preventDefault: true,\n      onTrigger: () => {\n        if (state.minimized) {\n          quickInputRef.current?.focus()\n          triggerHaptic(\"selection\")\n        }\n      },\n    },\n  ])\n\n  // Expose imperative API for popout/minimize and listen to CustomEvents\n  useEffect(() => {\n    const popoutListener = () => expandToPopout()\n    const minimizeListener = () => minimizeToBar()\n    const togglePopoutListener = () => toggleMinimize()\n\n    window.addEventListener('quickchat:popout', popoutListener)\n    window.addEventListener('quickchat:minimize', minimizeListener)\n    window.addEventListener('quickchat:toggle-popout', togglePopoutListener)\n\n    // Merge into global API without clobbering\n    const existing = (window as any).quickChat || {}\n    const injected = {\n      ...existing,\n      popout: expandToPopout,\n      minimize: minimizeToBar,\n      togglePopout: toggleMinimize,\n    }\n    ;(window as any).quickChat = injected\n\n    return () => {\n      window.removeEventListener('quickchat:popout', popoutListener)\n      window.removeEventListener('quickchat:minimize', minimizeListener)\n      window.removeEventListener('quickchat:toggle-popout', togglePopoutListener)\n      try {\n        const qc = (window as any).quickChat || {}\n        if (qc) {\n          delete qc.popout\n          delete qc.minimize\n          delete qc.togglePopout\n          if (Object.keys(qc).length === 0) {\n            delete (window as any).quickChat\n          } else {\n            ;(window as any).quickChat = qc\n          }\n        }\n      } catch {}\n    }\n  }, [])\n\n  // One-time hint for discoverability (only when minimized and first visit)\n  useEffect(() => {\n    if (!mounted) return\n    try {\n      const seen = localStorage.getItem(HINT_KEY)\n      if (!seen && state.minimized) {\n        setShowHint(true)\n        const id = setTimeout(() => {\n          try { localStorage.setItem(HINT_KEY, \"1\") } catch {}\n          setShowHint(false)\n        }, 6000)\n        return () => clearTimeout(id)\n      }\n    } catch {}\n  }, [mounted, state.minimized])\n\n  // Clamp to viewport on resize and keep popout aligned to bar width/offset\n  useEffect(() => {\n    const onResize = () => {\n      setState((s) => {\n        const isMin = s.minimized\n        const w = isMin ? s.w : computeBarWidth()\n        const x = isMin ? Math.min(Math.max(0, s.x), Math.max(0, window.innerWidth - w)) : Math.max(0, Math.floor((window.innerWidth - w) / 2))\n        const h = s.h\n        const y = isMin\n          ? Math.min(Math.max(0, s.y), Math.max(0, window.innerHeight - 56))\n          : Math.max(\n              16,\n              Math.floor(window.innerHeight - (BAR_BOTTOM_MARGIN + EST_BAR_HEIGHT + POPOUT_OFFSET_ABOVE_BAR) - h)\n            )\n        return { ...s, x, y, w, h }\n      })\n    }\n    window.addEventListener(\"resize\", onResize)\n    return () => window.removeEventListener(\"resize\", onResize)\n  }, [])\n\n  // Join a lightweight conversation when opened\n  useEffect(() => {\n    if (!state.minimized) {\n      joinConversation(miniChatConversationId)\n    }\n  }, [state.minimized, joinConversation, miniChatConversationId])\n\n  const onMouseMove = useCallback((e: MouseEvent) => {\n    if (dragging.current && dragStart.current) {\n      const dx = e.clientX - dragStart.current.mx\n      const dy = e.clientY - dragStart.current.my\n      setState((s) => {\n        const nx = Math.min(Math.max(0, dragStart.current!.x + dx), window.innerWidth - s.w)\n        const ny = Math.min(\n          Math.max(0, dragStart.current!.y + dy),\n          window.innerHeight - (s.minimized ? 56 : s.h)\n        )\n        return { ...s, x: nx, y: ny }\n      })\n    }\n    if (resizing.current && sizeStart.current) {\n      const dx = e.clientX - sizeStart.current.mx\n      const dy = e.clientY - sizeStart.current.my\n      setState((s) => {\n        const minW = 280\n        const minH = 260\n        const nw = Math.min(Math.max(minW, sizeStart.current!.w + dx), window.innerWidth - s.x)\n        const nh = Math.min(Math.max(minH, sizeStart.current!.h + dy), window.innerHeight - s.y)\n        return { ...s, w: nw, h: nh }\n      })\n    }\n  }, [])\n\n  const onMouseUp = useCallback(() => {\n    dragging.current = false\n    resizing.current = false\n    dragStart.current = null\n    sizeStart.current = null\n  }, [])\n\n  useEffect(() => {\n    window.addEventListener(\"mousemove\", onMouseMove)\n    window.addEventListener(\"mouseup\", onMouseUp)\n    return () => {\n      window.removeEventListener(\"mousemove\", onMouseMove)\n      window.removeEventListener(\"mouseup\", onMouseUp)\n    }\n  }, [onMouseMove, onMouseUp])\n\n  const startDrag = (e: React.MouseEvent) => {\n    dragging.current = true\n    dragStart.current = { mx: e.clientX, my: e.clientY, x: state.x, y: state.y }\n  }\n\n  const startResize = (e: React.MouseEvent) => {\n    e.stopPropagation()\n    resizing.current = true\n    sizeStart.current = { mx: e.clientX, my: e.clientY, w: state.w, h: state.h }\n  }\n\n  const dismissHint = () => {\n    setShowHint(false)\n    try { localStorage.setItem(HINT_KEY, \"1\") } catch {}\n  }\n\n  // Layout constants for the bottom bar and popout relationship\n  const BAR_SIDE_MARGIN = 16 // tailwind bottom-4/left-right margins in px\n  const BAR_BOTTOM_MARGIN = 16\n  const BAR_MAX_WIDTH = 720\n  const EST_BAR_HEIGHT = 48 // approximate height of the compact bar\n  const POPOUT_OFFSET_ABOVE_BAR = 15\n\n  const computeBarWidth = () => {\n    if (typeof window === \"undefined\") return Math.min(BAR_MAX_WIDTH, 360)\n    return Math.min(BAR_MAX_WIDTH, window.innerWidth - BAR_SIDE_MARGIN * 2)\n  }\n\n  const expandToPopout = () => {\n    setState((s) => {\n      const w = computeBarWidth()\n      const x = Math.max(0, Math.floor((window.innerWidth - w) / 2))\n      const h = s.h\n      const y = Math.max(\n        16,\n        Math.floor(window.innerHeight - (BAR_BOTTOM_MARGIN + EST_BAR_HEIGHT + POPOUT_OFFSET_ABOVE_BAR) - h)\n      )\n      return { ...s, minimized: false, w, x, y, h }\n    })\n  }\n\n  const minimizeToBar = () => {\n    setState((s) => ({ ...s, minimized: true }))\n  }\n\n  const toggleMinimize = () => {\n    dismissHint()\n    setState((s) => ({ ...s, minimized: !s.minimized }))\n  }\n\n  // Global hotkey: âŒ˜Q (and Ctrl+Q fallback) to toggle the Quick Chat popup\n  useHotkeys([\n    {\n      combo: \"meta+q\",\n      preventDefault: true,\n      enableInInputs: true,\n      onTrigger: () => {\n        toggleMinimize()\n        triggerHaptic(\"selection\")\n      },\n    },\n    {\n      combo: \"ctrl+q\",\n      preventDefault: true,\n      enableInInputs: true,\n      onTrigger: () => {\n        toggleMinimize()\n        triggerHaptic(\"selection\")\n      },\n    },\n  ])\n\n  // Resize helpers for header controls\n  const setCompactSize = () => {\n    setState((s) => ({ ...s, w: COMPACT_W, h: COMPACT_H }))\n  }\n\n  const setDefaultSize = () => {\n    setState((s) => ({ ...s, w: DEFAULT_W, h: DEFAULT_H }))\n  }\n\n  const onSend = () => {\n    const text = message.trim()\n    if (!text) return\n    try {\n      sendChatMessage(text, miniChatConversationId)\n    } catch {}\n    setMessage(\"\")\n  }\n\n  // Minimized compact bar (Appleâ€‘style)\n  if (state.minimized) {\n    if (!mounted) return null\n\n    const onQuickKeyDown = (e: React.KeyboardEvent<HTMLInputElement>) => {\n      const isComposing = (e.nativeEvent as any)?.isComposing\n      if (isComposing) return\n      if (e.key === \"Enter\" && !e.shiftKey) {\n        e.preventDefault()\n        if (message.trim()) {\n          try { sendChatMessage(message.trim(), miniChatConversationId) } catch {}\n          setMessage(\"\")\n          triggerHaptic(\"light\")\n          // After sending from the bar, open the popout to show the AI chat\n          expandToPopout()\n        }\n      } else if (e.key === \"Escape\") {\n        (e.currentTarget as HTMLInputElement).blur()\n      }\n    }\n\n    const bar = (\n      <div className=\"fixed z-[9999] bottom-4 left-1/2 -translate-x-1/2 w-[min(720px,calc(100%-2rem))]\">\n        <div\n          className=\"group flex items-center gap-2 rounded-2xl border border-gray-200/60 dark:border-gray-700/70 bg-white/80 dark:bg-gray-900/80 backdrop-blur supports-[backdrop-filter]:bg-white/70 supports-[backdrop-filter]:dark:bg-gray-900/70 shadow-lg hover:shadow-xl transition-shadow duration-200 motion-reduce:transition-none px-3 py-2\"\n          role=\"search\"\n          aria-label=\"Quick chat\"\n        >\n          <button\n            className=\"inline-flex items-center justify-center h-8 w-8 rounded-full text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-indigo-500\"\n            aria-label=\"New quick chat\"\n            onClick={() => { expandToPopout(); triggerHaptic(\"selection\") }}\n            type=\"button\"\n          >\n            <Plus className=\"h-4 w-4\" />\n          </button>\n\n          <input\n            ref={quickInputRef}\n            value={message}\n            onChange={(e) => setMessage(e.target.value)}\n            onKeyDown={onQuickKeyDown}\n            placeholder={\"Ask anything (âŒ˜L)\"}\n            className=\"flex-1 bg-transparent text-sm md:text-base placeholder:text-gray-500 dark:placeholder:text-gray-400 text-gray-900 dark:text-gray-100 outline-none\"\n            aria-label=\"Ask anything\"\n          />\n\n          {/* Subtle chips (non-interactive for now) */}\n          <div className=\"hidden sm:flex items-center gap-1 mr-1\">\n            <div className=\"hidden md:inline-flex items-center gap-1 text-xs text-gray-600 dark:text-gray-300 border border-gray-300/70 dark:border-gray-700 rounded-full px-2 py-1\">\n              <Code2 className=\"h-3.5 w-3.5\" />\n              <span>Code</span>\n            </div>\n            <div className=\"hidden lg:inline-flex items-center gap-1 text-[11px] text-gray-600 dark:text-gray-300 border border-gray-300/70 dark:border-gray-700 rounded-full px-2 py-1\">\n              <span>GPT-5 (high reasoning)</span>\n            </div>\n          </div>\n\n          <button\n            className=\"inline-flex items-center justify-center h-8 w-8 rounded-full text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-800 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-indigo-500\"\n            aria-label=\"Voice input\"\n            type=\"button\"\n            onClick={() => triggerHaptic(\"selection\")}\n          >\n            <Mic className=\"h-4 w-4\" />\n          </button>\n\n          <button\n            className=\"inline-flex items-center justify-center h-8 w-8 rounded-full bg-white text-gray-900 dark:bg-white dark:text-gray-900 shadow-sm hover:shadow focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-indigo-500\"\n            aria-label=\"Record\"\n            type=\"button\"\n            onClick={() => triggerHaptic(\"light\")}\n          >\n            <Circle className=\"h-4 w-4\" />\n          </button>\n        </div>\n      </div>\n    )\n\n    return createPortal(bar, document.body)\n  }\n\n  const content = (\n    <div\n      className=\"fixed z-[9999] rounded-2xl border border-gray-200/60 dark:border-gray-700/70 bg-white/80 dark:bg-gray-900/80 backdrop-blur supports-[backdrop-filter]:bg-white/70 supports-[backdrop-filter]:dark:bg-gray-900/70 shadow-2xl overflow-hidden\"\n      style={{ left: state.x, top: state.y, width: state.w, height: state.h }}\n    >\n      {/* Header (drag handle) */}\n      <div\n        className=\"cursor-move select-none flex items-center justify-between px-3 py-2 bg-white/60 dark:bg-gray-900/60 border-b border-gray-200/60 dark:border-gray-700/60 backdrop-blur\"\n        onMouseDown={startDrag}\n      >\n        <div className=\"flex items-center gap-2 text-gray-700 dark:text-gray-200\">\n          <Bot className=\"h-4 w-4\" />\n          <span className=\"text-sm font-medium\">{title}</span>\n        </div>\n        <div className=\"flex items-center gap-1\">\n          <Button\n            variant=\"ghost\"\n            size=\"icon\"\n            className=\"h-7 w-7\"\n            onMouseDown={(e) => e.stopPropagation()}\n            onClick={setCompactSize}\n            title=\"Minimize\"\n          >\n            <Minimize2 className=\"h-4 w-4\" />\n          </Button>\n          <Button\n            variant=\"ghost\"\n            size=\"icon\"\n            className=\"h-7 w-7\"\n            onMouseDown={(e) => e.stopPropagation()}\n            onClick={setDefaultSize}\n            title=\"Reset size\"\n          >\n            <Maximize2 className=\"h-4 w-4\" />\n          </Button>\n          <Button\n            variant=\"ghost\"\n            size=\"icon\"\n            className=\"h-7 w-7\"\n            onMouseDown={(e) => e.stopPropagation()}\n            onClick={() => setState((s) => ({ ...s, minimized: true }))}\n            title=\"Close\"\n          >\n            <X className=\"h-4 w-4\" />\n          </Button>\n        </div>\n      </div>\n\n      {/* Feed-only content */}\n      <div className=\"flex-1 h-[calc(100%-42px)] overflow-y-auto p-3 text-sm text-gray-700 dark:text-gray-200 space-y-2\">\n        {messages.filter(m => m.conversationId === miniChatConversationId).length === 0 ? (\n          <p className=\"opacity-80\">Your quick chat feed will appear here.</p>\n        ) : (\n          messages\n            .filter(m => m.conversationId === miniChatConversationId)\n            .map(m => (\n              <div key={m.id} className=\"rounded-lg border border-gray-200/60 dark:border-gray-700/60 bg-white/60 dark:bg-gray-900/60 backdrop-blur px-3 py-2\">\n                <div className=\"text-[11px] text-gray-500 dark:text-gray-400 mb-1\">\n                  {m.senderName || (m.sender === 'user' ? 'You' : m.sender === 'ai' ? 'AI Assistant' : 'Contact')} Â· {new Date(m.timestamp).toLocaleTimeString()}\n                </div>\n                <div className=\"whitespace-pre-wrap text-gray-900 dark:text-gray-100\">{m.text}</div>\n              </div>\n            ))\n        )}\n      </div>\n\n      {/* Resize handle */}\n      <div\n        className=\"absolute right-0 bottom-0 w-4 h-4 cursor-se-resize\"\n        onMouseDown={startResize}\n      />\n    </div>\n  )\n\n  if (!mounted) return null\n  return createPortal(content, document.body)\n}\n"],"names":["MiniChatWidget","DEFAULT_W","DEFAULT_H","COMPACT_W","COMPACT_H","defaultX","window","Math","max","innerWidth","defaultY","innerHeight","DEFAULT_STATE","minimized","x","y","w","h","STORAGE_KEY","HINT_KEY","title","initialMinimized","initialX","initialY","initialW","initialH","conversationId","state","setState","useState","message","setMessage","mounted","setMounted","showHint","setShowHint","quickInputRef","useRef","sendChatMessage","joinConversation","messages","useWebSocket","triggerHaptic","useHaptics","miniChatConversationId","useMemo","KEY","cid","localStorage","getItem","Date","now","floor","random","setItem","dragging","resizing","dragStart","sizeStart","useEffect","raw","parsed","JSON","parse","s","stringify","useHotkeys","combo","preventDefault","onTrigger","current","focus","popoutListener","expandToPopout","minimizeListener","minimizeToBar","togglePopoutListener","toggleMinimize","addEventListener","existing","quickChat","injected","popout","minimize","togglePopout","removeEventListener","qc","Object","keys","length","seen","id","setTimeout","clearTimeout","onResize","isMin","computeBarWidth","min","BAR_BOTTOM_MARGIN","EST_BAR_HEIGHT","POPOUT_OFFSET_ABOVE_BAR","onMouseMove","useCallback","e","dx","clientX","mx","dy","clientY","my","nx","ny","minW","minH","nw","nh","onMouseUp","startDrag","startResize","stopPropagation","dismissHint","BAR_SIDE_MARGIN","BAR_MAX_WIDTH","enableInInputs","setCompactSize","setDefaultSize","onSend","text","trim","onQuickKeyDown","isComposing","nativeEvent","key","shiftKey","currentTarget","blur","bar","div","className","role","aria-label","button","onClick","type","Plus","input","ref","value","onChange","target","onKeyDown","placeholder","Code2","span","Mic","Circle","createPortal","document","body","content","style","left","top","width","height","onMouseDown","Bot","Button","variant","size","Minimize2","Maximize2","X","filter","m","p","map","senderName","sender","timestamp","toLocaleTimeString"],"mappings":"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"}