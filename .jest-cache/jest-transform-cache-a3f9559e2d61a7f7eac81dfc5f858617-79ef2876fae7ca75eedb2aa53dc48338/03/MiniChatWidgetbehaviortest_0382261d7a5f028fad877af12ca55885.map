{"version":3,"sources":["/Users/elicharlese/CascadeProjects/AGENT/__tests__/components/MiniChatWidget.behavior.test.tsx"],"sourcesContent":["import React from 'react'\nimport { render, screen, waitFor, fireEvent } from '@testing-library/react'\nimport userEvent from '@testing-library/user-event'\nimport { QuickChatMount } from '@/components/chat/QuickChatMount'\n\n// Stub websocket hook to avoid network/auth during tests\njest.mock('@/hooks/use-websocket', () => ({\n  useWebSocket: () => ({\n    sendChatMessage: jest.fn(),\n    joinConversation: jest.fn(),\n    messages: [],\n  }),\n}))\n\n// Haptics no-op\njest.mock('@/hooks/use-haptics', () => ({\n  useHaptics: () => ({ triggerHaptic: () => {} }),\n}))\n\ndescribe('MiniChatWidget behavior via QuickChatMount', () => {\n  test('Enter on minimized bar opens feed-only popout and hides bar', async () => {\n    render(<QuickChatMount />)\n\n    const input = await screen.findByPlaceholderText(/ask anything/i)\n    await userEvent.type(input, 'help{enter}')\n\n    // Popout header appears\n    expect(await screen.findByText('Quick Chat')).toBeInTheDocument()\n    // Minimized bar input disappears\n    expect(screen.queryByPlaceholderText(/ask anything/i)).not.toBeInTheDocument()\n\n    // The popout container width aligns to computeBarWidth\n    const header = screen.getByText('Quick Chat')\n    const container = header.closest('div[style]') as HTMLDivElement\n    expect(container).toBeTruthy()\n\n    const expectedW = Math.min(720, (window.innerWidth || 1024) - 32)\n    expect(container.style.width).toBe(`${expectedW}px`)\n  })\n\n  test('Header Close button minimizes back to bar', async () => {\n    render(<QuickChatMount />)\n    // Open popout\n    fireEvent(window, new Event('quickchat:popout'))\n    const header = await screen.findByText('Quick Chat')\n    // Click Close button (title=\"Close\")\n    const closeBtn = header.parentElement?.parentElement?.querySelector('button[title=\"Close\"]') as HTMLButtonElement\n    expect(closeBtn).toBeTruthy()\n    await userEvent.click(closeBtn)\n    // Popout hidden, bar visible\n    await waitFor(() => expect(screen.queryByText('Quick Chat')).not.toBeInTheDocument())\n    expect(await screen.findByRole('search', { name: /quick chat/i })).toBeInTheDocument()\n  })\n\n  test('Hotkeys: ⌘Q/Ctrl+Q toggle popout; ⌘L focuses quick input when minimized', async () => {\n    render(<QuickChatMount />)\n    // Initially minimized, bar visible\n    const bar = await screen.findByRole('search', { name: /quick chat/i })\n    expect(bar).toBeInTheDocument()\n\n    // ⌘Q opens popout\n    fireEvent.keyDown(window, { key: 'q', code: 'KeyQ', metaKey: true })\n    await waitFor(() => expect(screen.getByText('Quick Chat')).toBeInTheDocument())\n\n    // Ctrl+Q minimizes back to bar\n    fireEvent.keyDown(window, { key: 'q', code: 'KeyQ', ctrlKey: true })\n    await waitFor(() => expect(screen.queryByText('Quick Chat')).not.toBeInTheDocument())\n    expect(await screen.findByRole('search', { name: /quick chat/i })).toBeInTheDocument()\n\n    // ⌘L focuses the quick input\n    const input = screen.getByLabelText('Ask anything') as HTMLInputElement\n    expect(input).toBeInTheDocument()\n    fireEvent.keyDown(window, { key: 'l', code: 'KeyL', metaKey: true })\n    await waitFor(() => expect(input).toHaveFocus())\n  })\n\n  test('Drag/resize persists to localStorage and clamps within viewport', async () => {\n    // Ensure predictable viewport\n    const origInner = Object.getOwnPropertyDescriptor(window, 'innerWidth')\n    const origInnerH = Object.getOwnPropertyDescriptor(window, 'innerHeight')\n    Object.defineProperty(window, 'innerWidth', { configurable: true, value: 1200 })\n    Object.defineProperty(window, 'innerHeight', { configurable: true, value: 800 })\n\n    const { unmount } = render(<QuickChatMount />)\n    // Open popout to enable drag/resize\n    fireEvent(window, new Event('quickchat:popout'))\n    const headerText = await screen.findByText('Quick Chat')\n    const container = headerText.closest('div[style]') as HTMLDivElement\n    expect(container).toBeTruthy()\n\n    // Drag: start at (300, 300) then move far negative to test clamping\n    const headerEl = headerText.parentElement?.parentElement as HTMLDivElement\n    fireEvent.mouseDown(headerEl, { clientX: 300, clientY: 300 })\n    fireEvent.mouseMove(window, { clientX: -1000, clientY: -1000 })\n    fireEvent.mouseUp(window)\n\n    // Resize: grab handle and increase size\n    const resizeHandle = container.querySelector('[class*=\"cursor-se-resize\"]') as HTMLDivElement\n    expect(resizeHandle).toBeTruthy()\n    const prevWidth = parseInt(container.style.width)\n    const prevHeight = parseInt(container.style.height)\n    fireEvent.mouseDown(resizeHandle, { clientX: 0, clientY: 0 })\n    fireEvent.mouseMove(window, { clientX: 200, clientY: 150 })\n    fireEvent.mouseUp(window)\n\n    // Read persisted state\n    const raw = window.localStorage.getItem('miniChatWidgetState')\n    expect(raw).toBeTruthy()\n    const persisted = JSON.parse(raw as string) as { x: number; y: number; w: number; h: number }\n    expect(persisted.x).toBeGreaterThanOrEqual(0)\n    expect(persisted.y).toBeGreaterThanOrEqual(0)\n    expect(persisted.w).toBeGreaterThanOrEqual(prevWidth)\n    expect(persisted.h).toBeGreaterThanOrEqual(prevHeight)\n    // Also clamp within viewport bounds (x + w <= innerWidth, y + h <= innerHeight)\n    expect(persisted.x + persisted.w).toBeLessThanOrEqual(1200)\n    expect(persisted.y + persisted.h).toBeLessThanOrEqual(800)\n\n    // Unmount and remount to verify persistence is used (minimized on mount by prop, but size persists)\n    unmount()\n    render(<QuickChatMount />)\n    // Open again and verify size at least matches persisted\n    fireEvent(window, new Event('quickchat:popout'))\n    const header2 = await screen.findByText('Quick Chat')\n    const container2 = header2.closest('div[style]') as HTMLDivElement\n    const w2 = parseInt(container2.style.width)\n    const h2 = parseInt(container2.style.height)\n    const viewportMaxW = Math.min(720, (window.innerWidth || 1024) - 32)\n    // On apply, width should be clamped to viewportMaxW and not exceed persisted\n    expect(w2).toBeLessThanOrEqual(persisted.w)\n    expect(w2).toBeLessThanOrEqual(viewportMaxW)\n    // Height should be within viewport bounds\n    expect(h2).toBeLessThanOrEqual(window.innerHeight)\n\n    // Restore viewport descriptors\n    if (origInner) Object.defineProperty(window, 'innerWidth', origInner)\n    if (origInnerH) Object.defineProperty(window, 'innerHeight', origInnerH)\n  })\n\n  test('CustomEvents control popout/minimize/toggle-popout', async () => {\n    render(<QuickChatMount />)\n\n    // Initially minimized bar\n    expect(await screen.findByRole('search', { name: /quick chat/i })).toBeInTheDocument()\n\n    // Popout event\n    fireEvent(window, new Event('quickchat:popout'))\n    await waitFor(() => expect(screen.getByText('Quick Chat')).toBeInTheDocument())\n\n    // Minimize event\n    fireEvent(window, new Event('quickchat:minimize'))\n    await waitFor(() => expect(screen.queryByText('Quick Chat')).not.toBeInTheDocument())\n    expect(screen.getByRole('search', { name: /quick chat/i })).toBeInTheDocument()\n\n    // Toggle-popout event: should open\n    fireEvent(window, new Event('quickchat:toggle-popout'))\n    await waitFor(() => expect(screen.getByText('Quick Chat')).toBeInTheDocument())\n\n    // Ensure API is present and functional\n    const qc = (window as any).quickChat\n    expect(typeof qc.popout).toBe('function')\n    expect(typeof qc.minimize).toBe('function')\n    expect(typeof qc.togglePopout).toBe('function')\n  })\n\n  test('Popout width updates on window resize to match bar width', async () => {\n    const originalDesc = Object.getOwnPropertyDescriptor(window, 'innerWidth')\n    Object.defineProperty(window, 'innerWidth', { configurable: true, value: 1000 })\n    render(<QuickChatMount />)\n\n    // Open popout\n    fireEvent(window, new Event('quickchat:popout'))\n    const header = await screen.findByText('Quick Chat')\n    let container = header.closest('div[style]') as HTMLDivElement\n    expect(container.style.width).toBe(`${Math.min(720, 1000 - 32)}px`)\n\n    // Shrink viewport and dispatch resize\n    Object.defineProperty(window, 'innerWidth', { configurable: true, value: 400 })\n    fireEvent(window, new Event('resize'))\n\n    await waitFor(() => {\n      container = header.closest('div[style]') as HTMLDivElement\n      expect(container.style.width).toBe(`${Math.min(720, 400 - 32)}px`)\n    })\n    if (originalDesc) {\n      Object.defineProperty(window, 'innerWidth', originalDesc)\n    }\n  })\n})\n"],"names":["jest","mock","useWebSocket","sendChatMessage","fn","joinConversation","messages","useHaptics","triggerHaptic","describe","test","render","QuickChatMount","input","screen","findByPlaceholderText","userEvent","type","expect","findByText","toBeInTheDocument","queryByPlaceholderText","not","header","getByText","container","closest","toBeTruthy","expectedW","Math","min","window","innerWidth","style","width","toBe","fireEvent","Event","closeBtn","parentElement","querySelector","click","waitFor","queryByText","findByRole","name","bar","keyDown","key","code","metaKey","ctrlKey","getByLabelText","toHaveFocus","origInner","Object","getOwnPropertyDescriptor","origInnerH","defineProperty","configurable","value","unmount","headerText","headerEl","mouseDown","clientX","clientY","mouseMove","mouseUp","resizeHandle","prevWidth","parseInt","prevHeight","height","raw","localStorage","getItem","persisted","JSON","parse","x","toBeGreaterThanOrEqual","y","w","h","toBeLessThanOrEqual","header2","container2","w2","h2","viewportMaxW","innerHeight","getByRole","qc","quickChat","popout","minimize","togglePopout","originalDesc"],"mappings":"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"}